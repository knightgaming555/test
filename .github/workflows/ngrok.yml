name: expose-with-ngrok
on:
  workflow_dispatch:

jobs:
  run-and-expose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Start server
        run: |
          nohup node server.js > server.log 2>&1 &
          sleep 2
          echo "Server started on port 3000"

      - name: Start ngrok
        id: start_ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          npx ngrok@4 http 3000 --authtoken="$NGROK_TOKEN" --log=stdout > ngrok.log 2>&1 &
          echo "Starting ngrok..."
          # Wait for ngrok to start
          for i in $(seq 1 15); do
            sleep 1
            if curl -s http://127.0.0.1:4040/api/tunnels >/dev/null 2>&1; then
              break
            fi
          done
          URL=$(curl -s http://127.0.0.1:4040/api/tunnels | python3 -c "import sys,json; j=json.load(sys.stdin); print(j['tunnels'][0]['public_url'] if j.get('tunnels') else '')")
          echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
          echo "Public ngrok URL: $URL"

      - name: Print access info
        run: |
          echo "Access with:"
          echo "Username: ${{ secrets.NGROK_APP_USERNAME }}"
          echo "Password: ${{ secrets.NGROK_APP_PASSWORD }}"
