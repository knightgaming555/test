name: expose-with-ngrok
on:
  workflow_dispatch:

jobs:
  run-and-expose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Start server
        run: |
          nohup node server.js > server.log 2>&1 &
          sleep 2
          echo "Server started on port 3000 (check server.log for errors)."

      - name: Install utilities
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq wget tar

      - name: Download & install ngrok v3
        run: |
          echo "Downloading official ngrok v3 binary..."
          # For x86_64 runners (default). If your runner is arm64, replace filename accordingly.
          wget -q -O ngrok-v3.tgz "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz"
          sudo tar -xzf ngrok-v3.tgz -C /usr/local/bin
          sudo chmod +x /usr/local/bin/ngrok
          /usr/local/bin/ngrok version || true
          echo "ngrok v3 installed."

      - name: Start ngrok and get public URL
        id: start_ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          /usr/local/bin/ngrok http 3000 --authtoken="$NGROK_TOKEN" --log=stdout > ngrok.log 2>&1 &
          echo "ngrok started, waiting for API..."

          URL=""
          for i in $(seq 1 30); do
            sleep 1
            DATA=$(curl -s http://127.0.0.1:4040/api/tunnels || true)
            if [ -n "$DATA" ] && echo "$DATA" | jq -e . >/dev/null 2>&1; then
              URL=$(echo "$DATA" | jq -r '.tunnels[0].public_url // empty')
              if [ -n "$URL" ]; then
                break
              fi
            fi
          done

          if [ -z "$URL" ]; then
            echo "API returned empty or invalid JSON; trying ngrok.log fallback..."
            URL=$(grep -oE 'https?://[a-z0-9.-]+\.ngrok(io|free.app|app)' ngrok.log | head -n1 || true)
          fi

          if [ -z "$URL" ]; then
            echo "Failed to get ngrok URL."
            echo "---- ngrok.log (last 200 lines) ----"
            tail -n 200 ngrok.log || true
            echo "---- server.log (last 200 lines) ----"
            tail -n 200 server.log || true
            exit 1
          fi

          echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
          echo "Public ngrok URL: $URL"

      - name: Print access info
        run: |
          echo "Public URL: ${{ steps.start_ngrok.outputs.ngrok_url }}"
          echo "Username: ${{ secrets.NGROK_APP_USERNAME }}"
          echo "Password: ${{ secrets.NGROK_APP_PASSWORD }}"

      - name: Keep workflow running until cancelled
        run: |
          echo "Workflow will keep running and ngrok will stay active until you CANCEL this run in the Actions UI."
          echo "To stop the tunnel: Actions → this workflow run → Cancel workflow."
          sleep infinity
